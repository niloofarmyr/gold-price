<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>محاسبه قیمت طلا</title>
<style>
  :root { --brand:#b8860b; --bg:#fffaf0; --ink:#222; --muted:#666; }
  *{box-sizing:border-box}
  body{font-family:Tahoma,Vazirmatn,sans-serif;margin:0;background:var(--bg);color:var(--ink);padding:24px;line-height:1.7;text-align:center}
  h1{color:var(--brand);margin:0 0 8px}
  .card{max-width:680px;margin:0 auto;background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.06),0 2px 8px rgba(0,0,0,.04);text-align:right}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  label{font-size:14px;color:#444}
  input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:8px;font-size:16px}
  .row{display:flex;gap:8px;align-items:center;margin-top:12px}
  .btn{cursor:pointer;border:0;border-radius:10px;padding:12px 16px;font-size:16px;font-weight:700;background:var(--brand);color:#fff;width:100%}
  .ghost{background:#f2f2f2;color:#222}
  .price{font-size:28px;font-weight:800;text-align:center;margin-top:14px}
  .muted{color:var(--muted);font-size:13px;text-align:center}
  .pill{display:inline-block;background:#f7efe0;color:#6b4b00;padding:4px 10px;border-radius:999px;font-size:12px}
</style>
</head>
<body>
  <h1>محاسبه قیمت محصول طلا</h1>
  <div class="card">
    <div class="grid">
      <div><label>وزن (گرم)</label><input id="weight" type="number" step="0.001" value="12.380"></div>
      <div><label>عیار</label><input id="karat" type="number" step="1" value="18"></div>
      <div><label>اجرت (%)</label><input id="ajrat" type="number" step="0.1" value="20"></div>
      <div><label>سود فروشنده (%)</label><input id="profit" type="number" step="0.1" value="7"></div>
      <div><label>مالیات بر سود (%)</label><input id="tax" type="number" step="0.1" value="9"></div>
      <div><label>قیمت هر گرم ۱۸ عیار (تومان)</label><input id="gold18" type="number" step="1000" placeholder="درحال دریافت..." disabled></div>
    </div>
    <div class="row">
      <button class="btn" id="calcBtn">محاسبه قیمت</button>
      <button class="btn ghost" id="copyBtn">کپی قیمت</button>
    </div>
    <div class="price" id="result">---</div>
    <div class="muted" id="ts"></div>
    <div class="muted" id="error"></div>
    <div class="pill">قیمت ۱۸ عیار به‌صورت خودکار از TGJU به روز می‌شود</div>
  </div>

<script>
// این اسکریپت پس از لود شدن صفحه اجرا می‌شود و قیمت لحظه‌ای طلا ۱۸ عیار را
// از سرویس Proxy (مثلاً Cloudflare Worker) می‌گیرد. اگر خطایی رخ دهد یا
// کاربر اتصال به اینترنت نداشته باشد، امکان وارد کردن دستی قیمت فراهم می‌شود.

(function(){
  // آدرس فایل JSON که توسط GitHub Actions تولید می‌شود
  const DATA_URL = "./data/gold18.json";
  const nf = new Intl.NumberFormat("fa-IR");
  const $ = id => document.getElementById(id);

  // تلاش برای دریافت قیمت از فایل JSON داخلی
  async function fetchGold18(){
    try{
      $("gold18").placeholder = "درحال دریافت...";
      // از فایل داده‌ها در مخزن خوانده می‌شود. مرورگر ممکن است کش را نگه دارد؛
      // با گذاشتن timestamp در querystring از کش جلوگیری می‌کنیم.
      const res = await fetch(`${DATA_URL}?_=${Date.now()}`, { cache: "no-store" });
      if(!res.ok) throw new Error("Network response was not ok");
      const data = await res.json();
      if(!data || typeof data.gold18_toman !== 'number') throw new Error("Invalid data");
      $("gold18").value = data.gold18_toman;
      $("gold18").disabled = false;
      $("ts").innerText = "به‌روز شده: " + new Date(data.updated_at).toLocaleString("fa-IR");
      $("error").innerText = "";
    }catch(e){
      // اگر خطا بود، اجازه‌ی ورود دستی بده و پیام خطا نمایش بده
      $("gold18").disabled = false;
      $("gold18").value = "";
      $("gold18").placeholder = "قیمت را دستی وارد کنید";
      $("error").innerText = "خطا در دریافت قیمت آنلاین: " + e.message;
    }
  }

  function calc(){
    const weight = +$("weight").value || 0;
    const karat  = +$("karat").value || 18;
    const ajratP = (+$("ajrat").value || 0)/100;
    const profitP= (+$("profit").value || 0)/100;
    const taxP   = (+$("tax").value || 0)/100;
    const gold18 = +$("gold18").value || 0;

    if(!gold18 || !weight){
      $("result").innerText = "لطفاً وزن و قیمت هر گرم ۱۸ عیار را وارد کنید.";
      return;
    }
    const goldPerGram = gold18 * (karat/18);
    const basePrice = weight * goldPerGram;
    const ajrat     = basePrice * ajratP;
    const profit    = (basePrice + ajrat) * profitP;
    const tax       = profit * taxP;
    const finalPrice= basePrice + ajrat + profit + tax;
    $("result").innerText = nf.format(Math.round(finalPrice)) + " تومان";
  }

  $("calcBtn").addEventListener("click", calc);
  $("copyBtn").addEventListener("click", ()=>{
    const text = $("result").innerText;
    if(!text || text === "---") calc();
    navigator.clipboard.writeText($("result").innerText).then(()=>{
      $("copyBtn").innerText = "کپی شد!";
      setTimeout(()=>$("copyBtn").innerText = "کپی قیمت",1200);
    });
  });

  // بارگذاری قیمت هنگام لود صفحه
  fetchGold18();
})();
</script>
</body>
</html>